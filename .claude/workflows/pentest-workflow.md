---
name: pentest-workflow
description: Automated penetration testing workflow using decision tree logic
version: 1.0.0
author: HTB Security Research
---

# Automated Penetration Testing Workflow

## Workflow Overview

This workflow implements an intelligent penetration testing system based on decision tree analysis from 23 Hack The Box machines. It coordinates multiple specialized agents to perform systematic security assessments.

## Workflow Architecture

```
┌────────────────────────────────────────────────────┐
│                  USER INPUT                        │
│                 /pentest <target>                  │
└────────────────────┬───────────────────────────────┘
                     ↓
┌────────────────────────────────────────────────────┐
│              DECISION AGENT                        │
│         (Master Orchestrator)                      │
│                                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │  Phase 1 │→ │  Phase 2 │→ │  Phase 3 │       │
│  │   RECON  │  │  EXPLOIT │  │  PRIVESC │       │
│  └──────────┘  └──────────┘  └──────────┘       │
│                                   ↓                │
│                            ┌──────────┐           │
│                            │  Phase 4 │           │
│                            │   LOOT   │           │
│                            └──────────┘           │
└────────────────────────────────────────────────────┘
                     ↓
┌────────────────────────────────────────────────────┐
│               FINAL REPORT                         │
└────────────────────────────────────────────────────┘
```

## Phase Definitions

### Phase 1: Reconnaissance (RECON)
**Agent**: `recon-agent`
**Objective**: Service discovery and enumeration
**Duration**: 2-3 minutes

**Activities**:
1. Port scanning with service detection
2. Technology identification
3. Version enumeration
4. Anonymous/null access checks
5. Banner grabbing

**Output**: JSON report with discovered services and attack vectors

### Phase 2: Exploitation (EXPLOIT)
**Agent**: `exploit-agent`
**Objective**: Gain initial foothold
**Duration**: 5-10 minutes

**Activities**:
1. Service-specific exploitation
2. Vulnerability testing
3. Credential attacks
4. Shell acquisition
5. Access stabilization

**Output**: Access details and discovered credentials

### Phase 3: Privilege Escalation (PRIVESC)
**Agent**: `privesc-agent`
**Objective**: Escalate to root/administrator
**Duration**: 5-15 minutes

**Activities**:
1. System enumeration
2. Misconfiguration detection
3. Vulnerability identification
4. Exploit execution
5. Persistence installation

**Output**: Root/admin access confirmation

### Phase 4: Data Extraction (LOOT)
**Agent**: `loot-agent`
**Objective**: Extract valuable information
**Duration**: 3-5 minutes

**Activities**:
1. Credential harvesting
2. Configuration extraction
3. Database dumping
4. Document retrieval
5. Report generation

**Output**: Comprehensive penetration test report

## Execution Flow

```yaml
workflow:
  name: pentest_execution
  steps:
    - step: validate_target
      action: verify_ip_format
      on_failure: abort

    - step: launch_reconnaissance
      agent: recon-agent
      timeout: 180
      inputs:
        target: ${TARGET_IP}
      outputs:
        services: ${DISCOVERED_SERVICES}
        attack_vectors: ${ATTACK_VECTORS}

    - step: analyze_results
      agent: decision-agent
      action: select_attack_vector
      inputs:
        services: ${DISCOVERED_SERVICES}
      outputs:
        priority_queue: ${ATTACK_QUEUE}

    - step: execute_exploitation
      agent: exploit-agent
      parallel: false
      for_each: ${ATTACK_QUEUE}
      timeout: 300
      inputs:
        target: ${TARGET_IP}
        method: ${item.method}
      outputs:
        access: ${INITIAL_ACCESS}
      on_success: continue_to_privesc
      on_failure: try_next_vector

    - step: privilege_escalation
      agent: privesc-agent
      condition: ${INITIAL_ACCESS} != null
      timeout: 600
      inputs:
        access: ${INITIAL_ACCESS}
      outputs:
        root_access: ${ROOT_ACCESS}

    - step: data_extraction
      agent: loot-agent
      condition: ${ROOT_ACCESS} == true OR ${INITIAL_ACCESS} != null
      timeout: 300
      inputs:
        access_level: ${ACCESS_LEVEL}
      outputs:
        loot_data: ${EXTRACTED_DATA}

    - step: generate_report
      agent: decision-agent
      action: compile_report
      inputs:
        all_data: ${WORKFLOW_DATA}
      outputs:
        report: ${FINAL_REPORT}
```

## Decision Points

### Service Priority Decision
```python
if port == 21 and anonymous_access:
    priority = 1
    action = "immediate_exploit"
elif port == 445:
    priority = 2
    action = "null_session_check"
elif port in [80, 443]:
    priority = 3
    action = "web_vulnerability_scan"
elif port == 22:
    priority = 4
    action = "credential_spray"
else:
    priority = 5
    action = "standard_enumeration"
```

### Failure Recovery Decision
```python
if exploit_failed:
    if attempts < 3:
        action = "try_alternative_exploit"
    else:
        action = "move_to_next_service"
elif no_credentials:
    action = "deeper_enumeration"
elif access_lost:
    action = "re_exploit_service"
```

## Parallel Operations

### Safe to Parallelize
- Service enumeration
- Technology detection
- Credential checking
- Documentation

### Must Run Sequentially
- Exploitation attempts
- Privilege escalation
- Shell stabilization
- Data exfiltration

## Configuration Parameters

```yaml
config:
  target_validation:
    enabled: true
    check_alive: true

  scanning:
    aggressive: false
    port_range: "1-65535"
    speed: "normal"  # slow, normal, fast

  exploitation:
    max_attempts: 3
    timeout_per_service: 300
    stealth_mode: false

  reporting:
    verbosity: "detailed"  # minimal, standard, detailed
    include_evidence: true
    sanitize_credentials: true

  safety:
    confirm_before_exploit: false
    rollback_on_failure: true
    log_all_actions: true
```

## Error Handling

### Common Errors and Recovery

| Error | Recovery Action | Fallback |
|-------|----------------|----------|
| Target unreachable | Verify network, retry | Abort mission |
| Service timeout | Increase timeout, retry | Skip service |
| Exploit failure | Try alternative method | Next vector |
| Agent crash | Restart agent | Manual intervention |
| Access lost | Re-exploit | Use persistence |

## Performance Metrics

### Success Criteria
- **Phase 1 Completion**: < 3 minutes
- **Initial Foothold**: < 10 minutes
- **Root Access**: < 20 minutes
- **Full Report**: < 30 minutes

### Monitoring Points
```yaml
metrics:
  - name: time_to_foothold
    measure: ${EXPLOIT_START} - ${FOOTHOLD_ACHIEVED}
  - name: time_to_root
    measure: ${FOOTHOLD_ACHIEVED} - ${ROOT_ACHIEVED}
  - name: services_exploited
    count: ${SUCCESSFUL_EXPLOITS}
  - name: credentials_discovered
    count: ${TOTAL_CREDENTIALS}
```

## Workflow Variations

### Quick Scan Mode
```yaml
variant: quick_scan
modifications:
  - skip: privilege_escalation
  - skip: data_extraction
  - limit: port_range: "21,22,80,443,445,3306"
  - reduce: timeout: 50%
```

### Stealth Mode
```yaml
variant: stealth
modifications:
  - enable: tor_proxy
  - reduce: scan_speed: "slow"
  - disable: aggressive_exploits
  - increase: delay_between_attempts: 30s
```

### Aggressive Mode
```yaml
variant: aggressive
modifications:
  - enable: all_exploits
  - parallel: exploitation_attempts
  - increase: max_attempts: 10
  - disable: stealth_checks
```

## Integration Points

### Input Sources
- Command line parameters
- Configuration files
- Previous scan results
- Credential databases

### Output Destinations
- JSON report files
- Markdown documentation
- Database storage
- API endpoints

## Workflow Commands

### Start Full Pentest
```bash
/pentest 10.10.10.10
```

### Start with Options
```bash
/pentest 10.10.10.10 --mode aggressive --report detailed
```

### Resume from Checkpoint
```bash
/pentest --resume session_12345
```

### Specific Service Target
```bash
/exploit-service 10.10.10.10 http
```

## Checkpoints and State

### Checkpoint Creation
```yaml
checkpoints:
  - after: reconnaissance_complete
  - after: foothold_achieved
  - after: privilege_escalated
  - before: data_extraction
```

### State Persistence
```json
{
  "session_id": "pentest_20240101_1234",
  "target": "10.10.10.10",
  "current_phase": "exploitation",
  "completed_phases": ["reconnaissance"],
  "discovered_services": [...],
  "gained_access": [...],
  "checkpoints": [...]
}
```

## Reporting Templates

### Executive Summary
- Target identification
- Critical findings
- Risk assessment
- Immediate recommendations

### Technical Details
- Attack chain visualization
- Vulnerability descriptions
- Exploitation methods
- Evidence screenshots

### Remediation Guide
- Priority-based fixes
- Security hardening steps
- Configuration changes
- Patch requirements

## Workflow Optimization

### Learning System
```python
# Track success patterns
success_patterns = []

# Adjust priorities based on success
def optimize_workflow(results):
    for result in results:
        if result.success:
            increase_priority(result.method)
        else:
            decrease_priority(result.method)

    save_optimizations()
```

### Performance Tuning
- Cache service fingerprints
- Reuse discovered credentials
- Skip known failures
- Prioritize successful patterns

## Safety and Ethics

### Pre-flight Checks
1. Verify target authorization
2. Check scope boundaries
3. Confirm test window
4. Review rollback procedures

### During Execution
1. Monitor system stability
2. Avoid destructive actions
3. Log all activities
4. Maintain access records

### Post-test Cleanup
1. Remove test accounts
2. Clear temporary files
3. Reset modified configs
4. Document changes made

## Troubleshooting

### Agent Communication Issues
```bash
# Check agent status
/agent-status all

# Restart specific agent
/agent-restart exploit-agent

# View agent logs
/agent-logs decision-agent --tail 50
```

### Workflow Stuck
```bash
# View current state
/workflow-status

# Force next phase
/workflow-skip-phase

# Abort and cleanup
/workflow-abort --cleanup
```

Remember: This workflow represents intelligent, adaptive penetration testing. Each decision shapes the path to compromise.
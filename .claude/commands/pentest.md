---
name: pentest
description: Comprehensive penetration testing workflow with proven attack patterns and modern cloud/container/API security
usage: /pentest <target> ["context"]
argument-hint: <IP or domain> ["additional context"]
disable-model-invocation: false
permissionMode: ask
examples:
  - /pentest 10.10.10.10
  - /pentest 10.10.10.10 "user: admin, password: Password123"
  - /pentest api.example.com "cloud: AWS, service: kubernetes"
  - /pentest graphql.example.com "type: GraphQL, auth: JWT"
allowed-tools: Bash(nmap:*), Bash(mkdir:*), Bash(ls:*), Bash(cat:*), Bash(curl:*), Bash(dig:*), Bash(nslookup:*), Bash(echo:*), Bash(grep:*), Bash(find:*), Bash(head:*), Bash(tail:*), Bash(sqlmap:*), Bash(hydra:*), Bash(mysql:*), Bash(ftp:*), Bash(smbclient:*), Bash(ssh:*), Bash(sudo:*), Bash(ps:*), Bash(netstat:*), Bash(id:*), Bash(whoami:*), Bash(uname:*), Bash(mount:*), Bash(docker:*), Bash(aws:*), Bash(az:*), Bash(gcloud:*), Bash(openssl:*), Bash(nc:*), Bash(python:*), Bash(base64:*), Bash(tar:*), Bash(gzip:*), Bash(cp:*), Bash(mv:*), Read(*), Write(*), Edit(*), Task, TodoWrite, Grep(*), WebFetch(*)
model: claude-sonnet-4-5-20250929
thinking: true
---

# Comprehensive Penetration Testing Workflow

## Overview
This workflow orchestrates specialized agents to perform comprehensive penetration testing following proven attack patterns and modern security testing approaches.

Target: **{{TARGET}}**
Context: **{{SUMMARY}}**

## Step 1: Initialize Session and Validate Target

First, validate the target and create a session:

```bash
# Validate target
~/.claude/skills/target-validation/scripts/validate-target.sh "{{TARGET}}"
if [ $? -ne 0 ]; then
    echo "Invalid target. Exiting."
    exit 1
fi

# Parse context if provided
if [ -n "{{SUMMARY}}" ]; then
    ~/.claude/skills/target-validation/scripts/parse-summary.sh "{{SUMMARY}}" "/tmp/context/"
fi

# Initialize session
export SESSION_ID=$(~/.claude/skills/session-management/scripts/session-manager.sh create "{{TARGET}}")
export SESSION_DIR="$HOME/.claude/sessions/$SESSION_ID"
mkdir -p "$SESSION_DIR"/{recon,loot,exploit,privesc,reports}
echo "Session initialized: $SESSION_ID"
```

## Step 2: Initial Reconnaissance

Launch recon-agent to enumerate the target. This agent WILL run nmap and save results:

Use a recon-agent to perform comprehensive reconnaissance on {{TARGET}}. The agent should scan all 65535 TCP ports using nmap, perform detailed service detection on discovered open ports, and save all results to /tmp/pentest_{{TARGET}}/.

Wait for recon-agent to complete scanning before proceeding.

## Step 3: Strategic Analysis with Decision Agent

Have the decision-agent analyze scan results and provide attack priorities:

Use a decision-agent to analyze the scan results for {{TARGET}} and provide attack priorities. The agent should review the results at /tmp/pentest_{{TARGET}}/service_scan.txt, apply HTB decision tree logic, and return prioritized attack vectors with success probabilities and recommended attack sequence.

## Step 4: Service-Based Exploitation Following HTB Patterns

Based on the reconnaissance results and decision-agent's analysis, test services in HTB priority order.

Read the scan results from /tmp/pentest_{{TARGET}}/service_scan.txt to identify which services are present.

### Priority 1: FTP Service (Port 21) - 100% HTB Success Rate

If FTP service (port 21) is identified as open in the scan results:
Use the Task tool to launch the loot-agent with the following prompt:
"You are a data extraction specialist. FTP service was found on {{TARGET}}.
Test for anonymous FTP access:
1. Verify FTP is running by checking /tmp/pentest_{{TARGET}}/service_scan.txt
2. Attempt anonymous login using ftp command
3. If successful, download ALL files found
4. Extract any credentials, SSH keys, or sensitive data
5. Save findings to /tmp/pentest_{{TARGET}}/loot/
6. Return discovered credentials for reuse testing"

If FTP is not present in scan results, skip FTP testing.

### Priority 2: SMB Service (Port 445) - 75% HTB Success Rate

If SMB service (port 445) is identified as open in the scan results:
Use the Task tool to launch the loot-agent with the following prompt:
"You are a data extraction specialist. SMB service was found on {{TARGET}}.
Test for null session access:
1. Verify SMB is running by checking scan results
2. Test null session with smbclient -L {{TARGET}} -N
3. Run enum4linux {{TARGET}} for complete enumeration
4. Extract usernames, groups, and shares
5. Download any accessible files from shares
6. Save findings to /tmp/pentest_{{TARGET}}/loot/
7. Return enumerated users for password spraying"

If SMB is not present in scan results, skip SMB testing.

### Priority 3: Web Services (80/443/8080/8443) - 85% HTB Success Rate

If HTTP/HTTPS services are identified as open in the scan results:
Use an exploit-agent to test web services found on {{TARGET}} for vulnerabilities. The agent should identify the technology stack, test for SQL injection, check default credentials, test file upload and LFI/RFI vulnerabilities, and save findings to /tmp/pentest_{{TARGET}}/exploit/.

If web services are not present in scan results, skip web testing.

### Additional High-Value Services

If MySQL (3306), RDP (3389), Redis (6379), or Telnet (23) are present:
Use exploit-agent to test default credentials on {{TARGET}}. These services have 100% success rate when defaults work.

## Step 5: Credential Testing and Reuse

If the loot-agent discovered credentials in previous steps:
Review any credentials saved to $SESSION_DIR/loot/credentials.txt.

For each discovered credential:
Test credential reuse on all identified services on {{TARGET}}:
- If SSH (port 22) is present: Test SSH login with discovered credentials
- If SMB (port 445) is present: Test SMB authentication
- If RDP (port 3389) is present: Test RDP login
- If web login forms were found: Test credentials on login pages

Document all successful logins for post-exploitation use.

## Step 6: Post-Exploitation

If any previous agent achieved initial foothold on {{TARGET}}:
Use the Task tool to launch the privesc-agent with the following prompt:
"You are a privilege escalation specialist. Initial access has been achieved on {{TARGET}}.
Escalate privileges to root/administrator:
1. Determine OS type (Linux/Windows) from initial access
2. For Linux: Check sudo -l, SUID binaries, capabilities, docker group, cron jobs
3. For Windows: Check token privileges, scheduled tasks, service misconfigurations
4. Apply GTFOBins techniques for identified vectors
5. Test kernel exploits as last resort
6. Document successful escalation path
7. Establish persistence if authorized"

If no foothold was achieved, skip privilege escalation.

## Step 7: Modern Infrastructure Testing

Based on the scan results, check for modern infrastructure:

### Container and Kubernetes Testing

If ports associated with Docker (2375/2376) or Kubernetes (6443/8443/10250) are present in scan results:
Use the Task tool to launch the exploit-agent with the following prompt:
"You are an exploitation specialist. Container/Kubernetes services were found on {{TARGET}}.
Test container security:
1. Run ~/.claude/skills/container-security/scripts/container-security.sh {{TARGET}}
2. Check for exposed Docker API
3. Test Kubernetes API authentication
4. Look for container escape vectors
5. Check RBAC misconfigurations
6. Test for exposed secrets
7. Return all container/K8s vulnerabilities found"

### API Security Testing

If the scan results or decision-agent identified API endpoints (/api, /graphql, /v1, /v2):
Use the Task tool to launch the exploit-agent with the following prompt:
"You are an exploitation specialist. API endpoints were found on {{TARGET}}.
Test API security:
1. Run ~/.claude/skills/api-security-testing/scripts/api-testing.sh {{TARGET}}
2. Test GraphQL introspection if GraphQL endpoint found
3. Check JWT implementation for vulnerabilities
4. Test CORS configuration
5. Check for SSRF vulnerabilities
6. Test for XXE, IDOR, and mass assignment
7. Return all API vulnerabilities found"

### Cloud Infrastructure Testing

If the target appears to be cloud infrastructure (based on headers, DNS, or service signatures):
Use the Task tool to launch the cloud-recon-agent with the following prompt:
"You are a cloud infrastructure specialist. Cloud services may be present on {{TARGET}}.
Enumerate cloud resources:
1. Run ~/.claude/skills/cloud-infrastructure/scripts/cloud-detection.sh {{TARGET}}
2. Identify cloud provider (AWS/Azure/GCP)
3. Check for public S3/storage buckets
4. Test for SSRF to metadata endpoints (169.254.169.254)
5. Enumerate IAM roles and policies if possible
6. Search for serverless function endpoints
7. Return all cloud misconfigurations found"

### Post-Exploitation Details

The privesc-agent handles OS-specific escalation with these priorities:

**Linux Escalation (HTB success rates):**
1. sudo -l misconfiguration (25%)
2. SUID binaries with GTFOBins (30%)
3. Writable /etc/passwd (rare but 100%)
4. Docker/LXD group membership (15%)
5. Cron job hijacking (10%)
6. Kernel exploits (last resort)

**Windows Escalation (HTB success rates):**
1. Token privileges abuse (30%)
2. Scheduled tasks with writable binaries (20%)
3. Service permission misconfigurations (25%)
4. AlwaysInstallElevated registry (rare but 100%)
5. Stored credentials (15%)
6. Unquoted service paths (10%)

## Step 8: Failure Recovery Analysis

If exploitation attempts have failed, consult decision-agent for recovery:

@decision-agent Previous exploitation attempts on {{TARGET}} have failed.
Analyze the situation and suggest recovery strategies.
Consider:
1. Alternative attack vectors not yet tried
2. Service version mismatches
3. Potential defensive measures (WAF, IPS)
4. Need for deeper enumeration (all ports, UDP)
Provide tactical recovery recommendations.

## Step 9: Apply Conditional Logic

Apply these HTB-proven decision rules (from decision-agent's analysis):

- If FTP anonymous succeeds → harvest credentials, skip brute force
- If SMB null session fails AND no usernames → skip password spray
- If SQL injection confirmed → use sqlmap, skip other web attacks
- If service version < vulnerable → skip exploit, try alternatives
- If credentials found → test on ALL services before brute forcing

## Step 10: Generate Final Report

Compile comprehensive report including:

**Traditional Infrastructure (HTB Patterns):**
- Services discovered with priority rankings
- Success rates vs HTB baselines
- Attack chains executed
- Credentials harvested

**Modern Infrastructure (if detected):**
- Cloud security findings (S3, IAM, SSRF)
- Container/K8s vulnerabilities
- API security issues

**Compliance & Scoring:**
- CVSS 3.1 scores
- OWASP Top 10 (2023) mapping
- CIS Benchmarks alignment
- NIST Framework coverage
- Risk matrix with remediation priorities

## Success Metrics

### HTB Baselines (Traditional Infrastructure)
- FTP anonymous access: 100% when present
- SMB null session: 75% when present
- Web vulnerabilities: 85% when present
- Credential reuse: 60% success rate
- Overall compromise: 80% target

### Modern Infrastructure (2025 Targets)
- Cloud misconfigurations: 65% of environments
- Container escapes: 45% when containers present
- API vulnerabilities: 75% when APIs exposed
- GraphQL introspection: 60% enabled
- JWT vulnerabilities: 40% weak implementation

## Important Notes

### HTB Pattern Adherence
1. **ALWAYS follow service priority order** (FTP → SMB → HTTP → Others) for traditional targets
2. **Execute attack chains completely** before trying alternatives
3. **Track success rates** against HTB baselines

### Modern Infrastructure Approach
4. **Detect cloud/container/API first** to adapt strategy
5. **Use specialized testing scripts** (cloud-detection.sh, container-security.sh, api-testing.sh)
6. **Apply compliance frameworks** for enterprise targets

### General Best Practices
7. **Use tool fallbacks** when primary tools unavailable
8. **Apply conditional logic** to avoid wasted attempts
9. **Generate comprehensive reports** covering all tested environments
10. **Maintain operational security** throughout testing